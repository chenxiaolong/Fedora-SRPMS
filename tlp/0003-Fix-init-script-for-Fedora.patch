From dbbf04fab4c5f043466e503c5735002d46a5a8c1 Mon Sep 17 00:00:00 2001
From: Xiao-Long Chen <chenxiaolong@cxl.epac.to>
Date: Tue, 3 Apr 2012 12:59:15 -0400
Subject: [PATCH 3/4] Fix init script for Fedora

---
 Makefile    |    7 +++--
 tlp.init    |   65 --------------------------------------------------------
 tlp.init.in |   68 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 3 files changed, 72 insertions(+), 68 deletions(-)
 delete mode 100755 tlp.init
 create mode 100755 tlp.init.in

diff --git a/Makefile b/Makefile
index 88c29a1..14c9817 100644
--- a/Makefile
+++ b/Makefile
@@ -27,6 +27,7 @@ clean-files:
 	rm -f tlp-rf
 	rm -f tlp-stat
 	rm -f tlp.upstart
+	rm -f tlp.init
 
 clean: clean-files
 	@/bin/true 
@@ -47,7 +48,7 @@ install-tlp:
 	install -D -m 755 tlp-usb-udev $(ULIB)/tlp-usb-udev
 	install -D -m 644 tlp.rules $(ULIB)/rules.d/40-tlp.rules
 	[ -f $(CONFFILE) ] || install -D -m 644 default $(CONFFILE)
-	install -D -m 755 tlp.init $(DESTDIR)/etc/init.d/tlp
+	install -D -m 755 tlp.init $(DESTDIR)/etc/rc.d/init.d/tlp
 	install -D -m 755 zztlp $(PLIB)/power.d/zztlp
 	install -D -m 755 49wwan $(PLIB)/sleep.d/49wwan
 	install -m 755 49bay $(PLIB)/sleep.d/49bay
@@ -64,7 +65,7 @@ install-rdw:
 create-files:
 	for i in \
 		48tlp-rdw-lock 49bay 49wwan tlp tlp-nop tlp-rdw-nm \
-		tlp-rdw-udev tlp-rf tlp-stat tlp.upstart; do \
+		tlp-rdw-udev tlp-rf tlp-stat tlp.upstart tlp.init; do \
 		sed 's/@LIBDIR@/$(LIBDIR)/g' <$$i.in >$$i; \
 	done
 
@@ -85,7 +86,7 @@ uninstall-tlp:
 	rmdir $(TLIB)
 	rm $(ULIB)/tlp-usb-udev
 	rm $(ULIB)/rules.d/40-tlp.rules
-	rm $(DESTDIR)/etc/init.d/tlp
+	rm $(DESTDIR)/etc/rc.d/init.d/tlp
 	rm $(DESTDIR)/etc/network/if-up.d/tlp-ifup
 	rm $(PLIB)/power.d/zztlp
 	rm $(PLIB)/sleep.d/49wwan
diff --git a/tlp.init b/tlp.init
deleted file mode 100755
index 06080cd..0000000
--- a/tlp.init
+++ /dev/null
@@ -1,65 +0,0 @@
-#!/bin/sh
-
-### BEGIN INIT INFO
-# Provides:          tlp
-# Required-Start:    $remote_fs $all
-# Required-Stop:     $remote_fs $all
-# Default-Start:     2 3 4 5
-# Default-Stop:      0 1 6
-# Short-Description: tlp start/stop script
-# Description:       Initialize tlp settings
-### END INIT INFO
-
-TLP=/usr/sbin/tlp
-LIB=/usr/@LIBEXECDIR@/tlp-pm/tlp-functions
-RFLIB=/usr/@LIBEXECDIR@/tlp-pm/tlp-rf-func
-
-[ -x $TLP ] || exit 0
-
-[ -f $LIB ] || exit 0
-[ -f $RFLIB ] || exit 0
-. $LIB
-. $RFLIB
-
-read_defaults || exit 0
-
-echo_debug "run" "+++ init.d $1"
-echo_debug "path" "PATH=$PATH"
-
-check_tlp_enabled || exit 0
-
-case $1 in
-    start|restart|force-reload)
-        echo -n "Loading tp-smapi kernel module..."
-        load_tp_modules
-        echo "done. "
-        
-        init_radio_devices start
-    
-        echo -n "Setting battery charge thresholds..."
-        set_charge_thresholds
-        echo "done."
-
-        UPWR=$(which upower)
-        if [ -n "$UPWR" ]; then
-            echo -n "Starting upowerd..."
-            $UPWR -e > /dev/null 2>&1
-            echo "done."
-            echo_debug "run" "upower_start"
-        fi
-        ;;
-        
-    stop)
-        init_radio_devices stop
-        
-        # Remove usb startup flag
-        [ -f $USB_DONE ] && rm $USB_DONE
-        ;;
-
-    *)
-        echo "Usage: tlp {start|stop|restart|force-reload}" >&2
-        exit 3
-        ;;
-esac
-
-exit 0
diff --git a/tlp.init.in b/tlp.init.in
new file mode 100755
index 0000000..3d864d3
--- /dev/null
+++ b/tlp.init.in
@@ -0,0 +1,68 @@
+#!/bin/sh
+#
+# chkconfig: - 90 10
+# description: Initialize tlp settings
+#
+### BEGIN INIT INFO
+# Provides:          tlp
+# Required-Start:    $remote_fs $all
+# Required-Stop:     $remote_fs $all
+# Default-Start:     2 3 4 5
+# Default-Stop:      0 1 6
+# Short-Description: tlp start/stop script
+# Description:       Initialize tlp settings
+### END INIT INFO
+
+TLP=/usr/sbin/tlp
+LIB=/usr/@LIBEXECDIR@/tlp-pm/tlp-functions
+RFLIB=/usr/@LIBEXECDIR@/tlp-pm/tlp-rf-func
+
+[ -x $TLP ] || exit 0
+
+[ -f $LIB ] || exit 0
+[ -f $RFLIB ] || exit 0
+. $LIB
+. $RFLIB
+
+read_defaults || exit 0
+
+echo_debug "run" "+++ init.d $1"
+echo_debug "path" "PATH=$PATH"
+
+check_tlp_enabled || exit 0
+
+case $1 in
+    start|restart|force-reload)
+        echo -n "Loading tp-smapi kernel module..."
+        load_tp_modules
+        echo "done. "
+        
+        init_radio_devices start
+    
+        echo -n "Setting battery charge thresholds..."
+        set_charge_thresholds
+        echo "done."
+
+        UPWR=$(which upower)
+        if [ -n "$UPWR" ]; then
+            echo -n "Starting upowerd..."
+            $UPWR -e > /dev/null 2>&1
+            echo "done."
+            echo_debug "run" "upower_start"
+        fi
+        ;;
+        
+    stop)
+        init_radio_devices stop
+        
+        # Remove usb startup flag
+        [ -f $USB_DONE ] && rm $USB_DONE
+        ;;
+
+    *)
+        echo "Usage: tlp {start|stop|restart|force-reload}" >&2
+        exit 3
+        ;;
+esac
+
+exit 0
-- 
1.7.7.6

